<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer de Alta Precis√£o - Se√ß√£o 4.3</title>
    <style>
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00d4ff;
            text-align: center;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        .status-panel {
            background: rgba(20, 20, 40, 0.9);
            border: 2px solid #00d4ff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .feature-check {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        .check-pass {
            color: #00ff88;
        }
        .check-fail {
            color: #ff4444;
        }
        .benchmark-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        button {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        button:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }
        .results-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 600px;
            overflow-y: auto;
        }
        .benchmark-result {
            background: rgba(20, 20, 40, 0.8);
            border-left: 4px solid #00d4ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .ratio-value {
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        .ratio-high {
            color: #ffff00;
        }
        .ratio-neutral {
            color: #00ffff;
        }
        .ratio-low {
            color: #ff00ff;
        }
        pre {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .timer-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            color: #00d4ff;
            font-weight: bold;
        }
        .stat-label {
            color: #888;
            margin-top: 5px;
        }
        .error-message {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .loading {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Timer de Alta Precis√£o com SharedArrayBuffer</h1>

        <div class="status-panel">
            <h2>Status do Sistema</h2>
            <div id="feature-checks">
                <div class="feature-check">
                    <span>SharedArrayBuffer</span>
                    <span id="sab-status">Verificando...</span>
                </div>
                <div class="feature-check">
                    <span>Web Workers</span>
                    <span id="worker-status">Verificando...</span>
                </div>
                <div class="feature-check">
                    <span>Headers COOP/COEP</span>
                    <span id="headers-status">Verificando...</span>
                </div>
                <div class="feature-check">
                    <span>WASM Module</span>
                    <span id="wasm-status">Verificando...</span>
                </div>
                <div class="feature-check">
                    <span>Timer Precision</span>
                    <span id="timer-status">N√£o calibrado</span>
                </div>
            </div>
        </div>

        <div class="timer-stats" id="timer-stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="calibration-rate">-</div>
                <div class="stat-label">Incrementos/segundo</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="timer-resolution">-</div>
                <div class="stat-label">Resolu√ß√£o (Œºs)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="perf-now-resolution">-</div>
                <div class="stat-label">performance.now() (ms)</div>
            </div>
        </div>

        <div class="benchmark-controls">
            <button id="init-btn" onclick="initializeSystem()">Inicializar Sistema</button>
            <button id="calibrate-btn" onclick="calibrateTimer()" disabled>Calibrar Timer</button>
            <button id="benchmark-btn" onclick="runPreciseBenchmark()" disabled>Executar Benchmark Preciso</button>
            <button id="compare-btn" onclick="compareTimers()" disabled>Comparar Timers</button>
            <button id="full-profile-btn" onclick="runFullProfile()" disabled>Perfil Completo</button>
        </div>

        <div id="error-container"></div>
        <div id="results-container" class="results-container" style="display: none;"></div>
    </div>

    <script src="./high-precision-timer.js"></script>
    <script src="./wasm-benchmark-precise.js"></script>
    <script type="module">
        import init, * as wasmModule from '/wasm-fingerprint/pkg/wasm_fingerprint.js';

        let benchmark = null;
        let standardTimer = null;

        // Verifica features dispon√≠veis
        function checkFeatures() {
            // SharedArrayBuffer
            const sabStatus = document.getElementById('sab-status');
            if (typeof SharedArrayBuffer !== 'undefined') {
                sabStatus.textContent = '‚úì Dispon√≠vel';
                sabStatus.className = 'check-pass';
            } else {
                sabStatus.textContent = '‚úó N√£o dispon√≠vel';
                sabStatus.className = 'check-fail';
            }

            // Web Workers
            const workerStatus = document.getElementById('worker-status');
            if (typeof Worker !== 'undefined') {
                workerStatus.textContent = '‚úì Dispon√≠vel';
                workerStatus.className = 'check-pass';
            } else {
                workerStatus.textContent = '‚úó N√£o dispon√≠vel';
                workerStatus.className = 'check-fail';
            }

            // Headers COOP/COEP
            const headersStatus = document.getElementById('headers-status');
            try {
                new SharedArrayBuffer(4);
                headersStatus.textContent = '‚úì Configurados';
                headersStatus.className = 'check-pass';
            } catch (e) {
                headersStatus.textContent = '‚úó N√£o configurados';
                headersStatus.className = 'check-fail';
                showError('Headers COOP/COEP n√£o configurados. SharedArrayBuffer n√£o dispon√≠vel.');
            }

            // Resolu√ß√£o do performance.now()
            measurePerformanceNowResolution();
        }

        function measurePerformanceNowResolution() {
            const measurements = [];
            for (let i = 0; i < 100; i++) {
                const t1 = performance.now();
                const t2 = performance.now();
                if (t2 > t1) {
                    measurements.push(t2 - t1);
                }
            }

            if (measurements.length > 0) {
                const minDiff = Math.min(...measurements);
                document.getElementById('perf-now-resolution').textContent =
                    minDiff.toFixed(3);
            }
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function showResults(content) {
            const container = document.getElementById('results-container');
            container.style.display = 'block';
            container.innerHTML = content;
        }

        window.initializeSystem = async function() {
            try {
                const initBtn = document.getElementById('init-btn');
                initBtn.disabled = true;
                initBtn.textContent = 'Inicializando...';

                // Inicializa WASM
                await init();
                document.getElementById('wasm-status').textContent = '‚úì Carregado';
                document.getElementById('wasm-status').className = 'check-pass';

                // Inicializa benchmark com timer de alta precis√£o
                benchmark = new PreciseWasmBenchmark();
                await benchmark.initialize(wasmModule);

                document.getElementById('timer-status').textContent = '‚úì Inicializado';
                document.getElementById('timer-status').className = 'check-pass';

                // Habilita outros bot√µes
                document.getElementById('calibrate-btn').disabled = false;
                document.getElementById('benchmark-btn').disabled = false;
                document.getElementById('compare-btn').disabled = false;
                document.getElementById('full-profile-btn').disabled = false;

                initBtn.textContent = 'Sistema Inicializado ‚úì';

            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showError(`Erro na inicializa√ß√£o: ${error.message}`);
                document.getElementById('init-btn').disabled = false;
                document.getElementById('init-btn').textContent = 'Tentar Novamente';
            }
        };

        window.calibrateTimer = async function() {
            if (!benchmark) {
                showError('Sistema n√£o inicializado');
                return;
            }

            try {
                const calibration = await benchmark.timer.calibrate();

                document.getElementById('timer-stats').style.display = 'grid';
                document.getElementById('calibration-rate').textContent =
                    Math.round(calibration.rate).toLocaleString();
                document.getElementById('timer-resolution').textContent =
                    ((1 / calibration.rate) * 1000000).toFixed(3);

                showResults(`
                    <div class="benchmark-result">
                        <h3>Calibra√ß√£o do Timer</h3>
                        <p>Taxa: ${calibration.rate.toFixed(0)} incrementos/segundo</p>
                        <p>Incrementos em 100ms: ${calibration.increments}</p>
                        <p>Resolu√ß√£o estimada: ${((1 / calibration.rate) * 1000000).toFixed(3)} Œºs</p>
                    </div>
                `);
            } catch (error) {
                showError(`Erro na calibra√ß√£o: ${error.message}`);
            }
        };

        window.runPreciseBenchmark = async function() {
            if (!benchmark) {
                showError('Sistema n√£o inicializado');
                return;
            }

            try {
                const result = await benchmark.runBenchmark('popcnt_or', 100000);

                const ratioClass = result.ratio > 1.15 ? 'ratio-high' :
                                  result.ratio < 0.85 ? 'ratio-low' : 'ratio-neutral';

                showResults(`
                    <div class="benchmark-result">
                        <h3>Benchmark: POPCNT vs OR (Timer de Alta Precis√£o)</h3>
                        <p>Itera√ß√µes: ${result.iterations.toLocaleString()}</p>
                        <p>Contagem agrupada: ${result.groupedCounts.toLocaleString()} ticks</p>
                        <p>Contagem intercalada: ${result.interleavedCounts.toLocaleString()} ticks</p>
                        <p>Tempo agrupado: ${result.groupedTime.toFixed(3)} ms</p>
                        <p>Tempo intercalado: ${result.interleavedTime.toFixed(3)} ms</p>
                        <div class="ratio-value ${ratioClass}">
                            Ratio œÅ = ${result.ratio.toFixed(4)}
                        </div>
                        <p>Interpreta√ß√£o: ${result.interpretation.description}</p>
                        <pre>${JSON.stringify(result.rawMeasurements, null, 2)}</pre>
                    </div>
                `);
            } catch (error) {
                showError(`Erro no benchmark: ${error.message}`);
            }
        };

        window.compareTimers = async function() {
            if (!benchmark) {
                showError('Sistema n√£o inicializado');
                return;
            }

            try {
                const iterations = 50000;

                // Medi√ß√£o com timer de alta precis√£o
                const preciseStart = benchmark.timer.now();
                wasmModule.grouped_execution_popcnt_or(iterations);
                const preciseEnd = benchmark.timer.now();
                const preciseDiff = preciseEnd - preciseStart;

                // Medi√ß√£o com performance.now()
                const standardStart = performance.now();
                wasmModule.grouped_execution_popcnt_or(iterations);
                const standardEnd = performance.now();
                const standardDiff = standardEnd - standardStart;

                showResults(`
                    <div class="benchmark-result">
                        <h3>Compara√ß√£o de Timers</h3>
                        <h4>Timer de Alta Precis√£o (SharedArrayBuffer)</h4>
                        <p>Diferen√ßa: ${preciseDiff} ticks</p>
                        <p>Tempo estimado: ${(preciseDiff / benchmark.timer.calibrationRate * 1000).toFixed(3)} ms</p>

                        <h4>performance.now() Padr√£o</h4>
                        <p>Diferen√ßa: ${standardDiff.toFixed(3)} ms</p>

                        <h4>An√°lise</h4>
                        <p>Resolu√ß√£o melhorada: ${(standardDiff > 0 ?
                            (preciseDiff / benchmark.timer.calibrationRate * 1000 / standardDiff).toFixed(2) :
                            'N/A')}x</p>
                    </div>
                `);
            } catch (error) {
                showError(`Erro na compara√ß√£o: ${error.message}`);
            }
        };

        window.runFullProfile = async function() {
            if (!benchmark) {
                showError('Sistema n√£o inicializado');
                return;
            }

            try {
                document.getElementById('full-profile-btn').disabled = true;
                document.getElementById('full-profile-btn').textContent = 'Executando...';

                const results = await benchmark.runFullProfile();
                const fingerprint = await benchmark.generateFingerprint(results);

                let html = '<h2>Perfil Microarquitetural Completo</h2>';

                for (const result of results) {
                    const ratioClass = result.ratio > 1.15 ? 'ratio-high' :
                                      result.ratio < 0.85 ? 'ratio-low' : 'ratio-neutral';

                    html += `
                        <div class="benchmark-result">
                            <h3>${result.instructionPair.toUpperCase()}</h3>
                            <p>Tempo agrupado: ${result.groupedTime.toFixed(3)} ms</p>
                            <p>Tempo intercalado: ${result.interleavedTime.toFixed(3)} ms</p>
                            <div class="ratio-value ${ratioClass}">
                                œÅ = ${result.ratio.toFixed(4)}
                            </div>
                            <p>${result.interpretation.description}</p>
                        </div>
                    `;
                }

                html += `
                    <div class="benchmark-result">
                        <h3>Fingerprint Microarquitetural</h3>
                        <p style="word-break: break-all; font-family: monospace;">
                            SHA-256: ${fingerprint}
                        </p>
                    </div>
                `;

                showResults(html);

                document.getElementById('full-profile-btn').disabled = false;
                document.getElementById('full-profile-btn').textContent = 'Perfil Completo';

            } catch (error) {
                showError(`Erro no perfil: ${error.message}`);
                document.getElementById('full-profile-btn').disabled = false;
                document.getElementById('full-profile-btn').textContent = 'Perfil Completo';
            }
        };

        // Cleanup ao sair
        window.addEventListener('beforeunload', async () => {
            if (benchmark) {
                await benchmark.cleanup();
            }
        });

        // Verifica features ao carregar
        checkFeatures();
    </script>
</body>
</html>